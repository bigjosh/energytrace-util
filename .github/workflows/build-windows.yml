name: Build Windows Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC developer environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x86

      - name: Generate import library from .def file
        run: lib /def:MSP430.def /out:MSP430.lib /machine:x86
        shell: cmd

      - name: Build with CMake (MSVC)
        run: |
          cmake -B build -A Win32 -DMSP430_LIBRARY="${{ github.workspace }}\MSP430.lib"
          cmake --build build --config Release
        shell: cmd

      - name: Prepare release artifacts
        run: |
          mkdir release
          copy build\Release\energytrace.exe release\
          copy README.md release\
        shell: cmd

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: energytrace-windows-x86
          path: release/

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/energytrace.exe
          body: |
            ## energytrace for Windows (x86)

            ### Requirements
            - **MSP430 Debug Stack (MSP430.DLL)** must be installed.
              Download from [TI's MSP Debug Stack](https://www.ti.com/tool/MSPDS) or install as part of Code Composer Studio.
            - Place `MSP430.DLL` in the same directory as `energytrace.exe`, or ensure it is on your system PATH.

            ### Usage
            ```
            energytrace.exe <measurement duration in seconds>
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build with CMake
        run: |
          cmake -B build
          cmake --build build
        # Will fail at link time without libmsp430.so installed,
        # but validates the source compiles correctly on Linux.
        continue-on-error: true
