name: Build Windows Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up MSVC developer environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Clone MSP Debug Stack for headers
        run: git clone --depth 1 https://github.com/AJenbo/mspds.git mspds-src
        shell: bash

      - name: Locate MSP430 headers
        id: headers
        run: |
          $headerDir = Get-ChildItem -Path mspds-src -Recurse -Filter "MSP430.h" -File | Select-Object -First 1 -ExpandProperty DirectoryName
          if (-not $headerDir) {
            Write-Error "MSP430.h not found in mspds source"
            exit 1
          }
          Write-Output "MSP430 headers found at: $headerDir"
          echo "MSP430_INCLUDE_DIR=$headerDir" >> $env:GITHUB_OUTPUT
        shell: pwsh

      - name: Generate import library from .def file
        run: lib /def:MSP430.def /out:MSP430.lib /machine:x64
        shell: cmd

      - name: Build with CMake (MSVC)
        run: |
          cmake -B build -A x64 -DMSP430_INCLUDE_DIR="${{ steps.headers.outputs.MSP430_INCLUDE_DIR }}" -DMSP430_LIBRARY="${{ github.workspace }}\MSP430.lib"
          cmake --build build --config Release
        shell: cmd

      - name: Prepare release artifacts
        run: |
          mkdir release
          copy build\Release\energytrace.exe release\
          copy README.md release\
        shell: cmd

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: energytrace-windows-x64
          path: release/

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/energytrace.exe
          body: |
            ## energytrace for Windows (x64)

            ### Requirements
            - **MSP430 Debug Stack (MSP430.DLL)** must be installed.
              Download from [TI's MSP Debug Stack](https://www.ti.com/tool/MSPDS) or install as part of Code Composer Studio.
            - Place `MSP430.DLL` in the same directory as `energytrace.exe`, or ensure it is on your system PATH.

            ### Usage
            ```
            energytrace.exe <measurement duration in seconds>
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Clone MSP Debug Stack for headers
        run: git clone --depth 1 https://github.com/AJenbo/mspds.git mspds-src

      - name: Locate MSP430 headers
        id: headers
        run: |
          HEADER_DIR=$(find mspds-src -name "MSP430.h" -printf '%h\n' | head -1)
          if [ -z "$HEADER_DIR" ]; then
            echo "MSP430.h not found in mspds source"
            exit 1
          fi
          echo "MSP430 headers found at: $HEADER_DIR"
          echo "MSP430_INCLUDE_DIR=$HEADER_DIR" >> "$GITHUB_OUTPUT"

      - name: Build with CMake
        run: |
          cmake -B build \
            -DMSP430_INCLUDE_DIR="${{ steps.headers.outputs.MSP430_INCLUDE_DIR }}"
          cmake --build build
        # Note: This will fail at link time without libmsp430.so installed,
        # but validates the source compiles correctly on Linux.
        continue-on-error: true

      - name: Build with Makefile (if libmsp430 is installed)
        run: |
          if [ -f /usr/include/libmsp430/MSP430.h ]; then
            make
          else
            echo "libmsp430 not installed, skipping Makefile build"
          fi
        continue-on-error: true
